# 历史记录系统技术文档

## 概述

历史记录系统为画布应用提供了完整的撤销/重做功能。系统采用快照（Snapshot）模式，在每次绘制操作完成时自动记录画布状态，支持用户通过撤销和重做操作来恢复历史状态。

## 架构设计

### 核心组件

历史记录系统由以下核心组件构成：

1. **类型定义层** (`src/types/history.ts`)
   - 定义历史快照的数据结构
   - 与导出 JSON 格式保持一致

2. **状态管理层** (`src/stores/history.ts`)
   - 管理历史快照的存储
   - 实现撤销/重做的核心逻辑

3. **画布状态转换层** (`src/stores/canvas.ts`)
   - 提供画布状态到快照的转换
   - 提供快照到画布状态的恢复

4. **组合式函数层** (`src/composables/useHistory.ts`)
   - 提供统一的历史操作 API
   - 封装状态管理和转换逻辑

5. **插件层** (`src/plugins/builtin/undo.ts`, `src/plugins/builtin/redo.ts`)
   - 实现撤销/重做插件
   - 支持快捷键和 UI 集成

6. **UI 组件层** (`src/components/UndoRedoButtons.vue`)
   - 提供工具栏按钮
   - 显示操作状态和快捷键提示

## 数据结构

### HistorySnapshot

历史快照采用与导出 JSON 相同的结构，确保数据格式的一致性：

```typescript
interface HistorySnapshot {
  version: string                    // 版本号，当前为 "1.0.0"
  metadata: HistoryMetadata          // 元数据
  objects: HistoryObject[]           // 画布对象数组
}

interface HistoryMetadata {
  exportedAt: string                 // 快照创建时间（ISO 格式）
  canvasZoom: number                 // 画布缩放比例
  canvasStyles: CanvasStyles         // 画布样式
}

interface CanvasStyles {
  fillColor: string                  // 填充颜色
  strokeColor: string                // 描边颜色
  strokeWidth: number                // 描边宽度
  fontSize: number                   // 字体大小
  textColor: string                  // 文本颜色
}

interface HistoryObject {
  id: string                         // 对象唯一标识
  type: string                       // 对象类型（rect, circle, line, arrow, pen, text, image）
  data: unknown                       // 对象数据（Leafer 元素的 JSON 序列化数据）
}
```

### 快照存储策略

- **最大历史记录数**: 50 条
- **存储方式**: 数组 + 索引指针
- **清理策略**: 当历史记录超过最大数量时，自动删除最旧的记录

## 核心实现

### 1. 历史状态管理 (History Store)

**文件**: `src/stores/history.ts`

**状态**:
- `snapshots`: 历史快照数组
- `currentIndex`: 当前快照索引（-1 表示无快照）

**核心方法**:

#### addSnapshot(snapshot: HistorySnapshot)
添加新的历史快照。

**逻辑**:
1. 如果当前不在历史记录末尾（存在可重做的记录），清除后续记录
2. 将新快照添加到数组末尾
3. 如果超过最大数量限制，删除最旧的记录
4. 更新当前索引到最新位置

**关键特性**:
- 自动清理分支历史：当用户在执行撤销后执行新操作时，会清除被撤销的记录
- 内存管理：限制最大历史记录数，防止内存溢出

#### undo(): HistorySnapshot | null
执行撤销操作。

**逻辑**:
1. 检查是否可以撤销（`currentIndex > 0`）
2. 将索引向前移动一位
3. 返回对应的快照

#### redo(): HistorySnapshot | null
执行重做操作。

**逻辑**:
1. 检查是否可以重做（`currentIndex < snapshots.length - 1`）
2. 将索引向后移动一位
3. 返回对应的快照

#### clearHistory()
清空所有历史记录。

### 2. 画布状态转换 (Canvas Store)

**文件**: `src/stores/canvas.ts`

#### toSnapshot(): HistorySnapshot
将当前画布状态转换为历史快照。

**实现步骤**:
1. 遍历所有画布对象，调用 `element.toJSON()` 序列化每个元素
2. 收集画布的元数据（缩放、样式等）
3. 构建符合 `HistorySnapshot` 格式的对象

**序列化方式**:
- 使用 Leafer 元素的原生 `toJSON()` 方法
- 保留元素的完整属性信息

#### fromSnapshot(snapshot: HistorySnapshot)
从历史快照恢复画布状态。

**实现步骤**:
1. 取消当前编辑器选择状态
2. 清除画布上的所有现有对象
3. 遍历快照中的对象数据：
   - 根据 `tag` 字段识别元素类型
   - 使用对应的 Leafer 构造函数创建元素
   - 将元素添加到画布树
   - 将对象添加到 store 的 objects 数组
4. 恢复画布的元数据（缩放、样式等）

**支持的元素类型**:
- `Rect`: 矩形
- `Ellipse`: 椭圆/圆形
- `Path`: 路径（用于线条）
- `Line`: 直线（用于箭头）
- `Pen`: 画笔
- `Text`: 文本
- `Image`: 图片

**错误处理**:
- 对于未知的元素类型，输出警告并跳过
- 对于创建失败的元素，捕获错误并记录日志

### 3. 组合式函数 (useHistory)

**文件**: `src/composables/useHistory.ts`

提供统一的历史操作 API，封装底层实现细节。

**API**:

```typescript
const {
  createSnapshot,    // 创建快照（不添加到历史）
  applySnapshot,     // 应用快照到画布
  undo,              // 撤销操作
  redo,              // 重做操作
  addSnapshot,       // 创建并添加快照到历史
  canUndo,           // 是否可以撤销（computed）
  canRedo            // 是否可以重做（computed）
} = useHistory()
```

**设计优势**:
- 统一接口：所有历史操作通过单一入口
- 响应式状态：`canUndo` 和 `canRedo` 自动更新
- 易于使用：组件只需调用简单的方法

### 4. 自动历史记录

系统在以下场景自动记录历史：

#### 拖拽绘制工具完成时
**位置**: `src/composables/useCanvasTools.ts` - `handleDragEnd()`

**触发工具**:
- 矩形工具 (rect)
- 圆形工具 (circle)
- 线条工具 (line)
- 箭头工具 (arrow)
- 画笔工具 (pen)

**记录条件**:
- 仅在对象成功添加到画布时记录（通过比较对象数量变化）
- 如果对象因尺寸过小被移除，不记录历史

**实现逻辑**:
```typescript
const objectCountBefore = store.objects.length
toolInstance.finishDrawing()
const objectCountAfter = store.objects.length

if (objectCountAfter > objectCountBefore) {
  addSnapshot()
}
```

#### 文本工具完成时
**位置**: `src/composables/useCanvasTools.ts` - `handleTap()`

**触发条件**: 工具类型为 `text` 且对象成功添加

#### 图片工具完成时
**位置**: `src/plugins/composables/useImageTool.ts`

**触发时机**: 图片文件加载完成并添加到画布后

**实现特点**: 由于图片加载是异步的，历史记录在 `FileReader.onload` 回调中执行

## 用户界面

### 撤销/重做按钮

**组件**: `src/components/UndoRedoButtons.vue`

**位置**: 工具栏左侧，与菜单下拉按钮相邻

**功能特性**:
- 两个独立的按钮（撤销/重做）
- 根据 `canUndo`/`canRedo` 状态自动禁用/启用
- 显示工具提示，包含操作名称和快捷键
- 样式与工具栏其他按钮保持一致

**快捷键支持**:
- 撤销: `Ctrl+Z` (实际快捷键格式: `Ctrl+KeyZ`)
- 重做: `Ctrl+Shift+Z` (实际快捷键格式: `Ctrl+Shift+KeyZ`)

### 插件集成

撤销和重做功能通过插件系统实现：

**Undo 插件** (`src/plugins/builtin/undo.ts`):
- 插件 ID: `undo`
- 快捷键: `Ctrl+KeyZ` (用户按下 `Ctrl+Z` 触发)
- 图标: `i-lucide-undo-2`
- 标签: `撤销`

**Redo 插件** (`src/plugins/builtin/redo.ts`):
- 插件 ID: `redo`
- 快捷键: `Ctrl+Shift+KeyZ` (用户按下 `Ctrl+Shift+Z` 触发)
- 图标: `i-lucide-redo-2`
- 标签: `重做`

**插件特性**:
- 遵循插件架构规范
- 支持快捷键绑定（使用 `KeyZ` 格式匹配 `KeyboardEvent.code`）
- 集成到工具栏 UI
- 通过 `onActivate` 钩子触发操作
- 在 `useCanvasTools.ts` 中作为特殊插件处理，直接调用 `onActivate` 而不切换工具

## 工作流程

### 记录历史流程

```
用户操作完成
    ↓
检查对象是否成功添加
    ↓
创建画布状态快照
    ↓
添加到历史记录
    ↓
更新当前索引
```

### 撤销流程

```
用户触发撤销（按钮/快捷键）
    ↓
检查是否可以撤销
    ↓
获取上一个快照
    ↓
恢复画布状态
    ↓
更新当前索引
    ↓
更新按钮状态（自动）
```

### 重做流程

```
用户触发重做（按钮/快捷键）
    ↓
检查是否可以重做
    ↓
获取下一个快照
    ↓
恢复画布状态
    ↓
更新当前索引
    ↓
更新按钮状态（自动）
```

## 性能考虑

### 内存管理

- **快照大小**: 每个快照包含完整的画布状态，可能包含大量数据
- **限制策略**: 最大历史记录数限制为 50 条
- **清理机制**: 超过限制时自动删除最旧的记录

### 序列化性能

- **序列化时机**: 仅在操作完成时执行，不影响绘制性能
- **序列化方式**: 使用 Leafer 原生的 `toJSON()` 方法，性能优化
- **异步处理**: 图片加载等异步操作在完成后记录历史

### 状态恢复性能

- **批量操作**: 恢复时先清除所有对象，再批量添加新对象
- **元素创建**: 使用 Leafer 构造函数直接创建，避免重复解析
- **错误隔离**: 单个元素恢复失败不影响其他元素

## 扩展性

### 添加新的历史记录点

要在新的操作点记录历史，只需：

1. 在操作完成后调用 `useHistory().addSnapshot()`
2. 确保操作确实改变了画布状态（如添加/删除对象）

**示例**:
```typescript
import { useHistory } from '@/composables/useHistory'

const { addSnapshot } = useHistory()

// 在操作完成后
if (operationSucceeded) {
  addSnapshot()
}
```

### 支持新的元素类型

要在历史记录中支持新的元素类型：

1. 在 `canvas.ts` 的 `fromSnapshot()` 方法中添加对应的 case
2. 确保元素类型有对应的 Leafer 构造函数
3. 确保元素的 `toJSON()` 方法正常工作

**示例**:
```typescript
case 'NewElementType':
  const { NewElementType } = require('leafer-ui')
  element = new NewElementType(data)
  break
```

## 注意事项

### 历史记录时机

- **仅在操作完成时记录**: 不在绘制过程中记录，避免产生过多无用的历史记录
- **仅在成功时记录**: 如果操作失败（如对象被移除），不记录历史
- **避免重复记录**: 确保同一操作只记录一次历史

### 状态一致性

- **完整快照**: 每次快照包含完整的画布状态，确保恢复时状态一致
- **元数据同步**: 画布的缩放、样式等元数据也会被记录和恢复
- **编辑器状态**: 恢复时会取消编辑器选择状态，避免状态不一致

### 错误处理

- **容错机制**: 单个元素恢复失败不影响其他元素
- **日志记录**: 错误会被记录到控制台，便于调试
- **降级处理**: 对于未知元素类型，会跳过并继续处理其他元素

## 文件清单

### 核心文件

- `src/types/history.ts` - 类型定义
- `src/stores/history.ts` - 历史状态管理
- `src/stores/canvas.ts` - 画布状态转换（`toSnapshot`, `fromSnapshot`）
- `src/composables/useHistory.ts` - 组合式函数 API

### 插件文件

- `src/plugins/builtin/undo.ts` - 撤销插件
- `src/plugins/builtin/redo.ts` - 重做插件
- `src/plugins/builtin/index.ts` - 插件注册

### UI 组件

- `src/components/UndoRedoButtons.vue` - 撤销/重做按钮组件
- `src/components/Toolbar.vue` - 工具栏（包含按钮）
- `src/components/IconRenderer.vue` - 图标渲染器（支持 undo/redo 图标）

### 集成点

- `src/composables/useCanvasTools.ts` - 绘制工具完成时的历史记录，以及撤销/重做快捷键的处理逻辑
- `src/plugins/composables/useImageTool.ts` - 图片工具完成时的历史记录

**快捷键处理说明**:
在 `useCanvasTools.ts` 中，undo 和 redo 插件被识别为特殊插件（与 export 插件类似），当快捷键触发时：
1. 直接创建或获取工具实例
2. 调用 `onActivate` 钩子执行撤销/重做操作
3. 不切换当前工具类型（与普通工具插件不同）

## 总结

历史记录系统采用快照模式，通过完整的状态序列化和反序列化实现撤销/重做功能。系统设计遵循以下原则：

1. **数据一致性**: 快照格式与导出格式保持一致
2. **性能优化**: 限制历史记录数量，优化序列化性能
3. **易于扩展**: 通过插件系统集成，易于添加新的历史记录点
4. **用户友好**: 提供 UI 按钮和快捷键支持，状态自动更新

系统已完整实现并集成到应用中，支持所有绘制工具的撤销/重做操作。

