# æ’ä»¶å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹æ’ä»¶å¼€å‘ï¼Œé™ä½æ’ä»¶å¼€å‘é—¨æ§›ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡æ¡£ï¼Œæ‚¨å°†äº†è§£å¦‚ä½•åˆ›å»ºã€æ³¨å†Œå’Œä½¿ç”¨æ’ä»¶æ¥æ‰©å±•ç”»å¸ƒå·¥å…·çš„åŠŸèƒ½ã€‚

## ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ’ä»¶æ¥å£è¯´æ˜](#æ’ä»¶æ¥å£è¯´æ˜)
- [èƒ½åŠ›å£°æ˜æŒ‡å—](#èƒ½åŠ›å£°æ˜æŒ‡å—)
- [å·¥å…·å®ä¾‹å®ç°](#å·¥å…·å®ä¾‹å®ç°)
- [äº‹ä»¶ç³»ç»Ÿä½¿ç”¨](#äº‹ä»¶ç³»ç»Ÿä½¿ç”¨)
- [é’©å­ç³»ç»Ÿä½¿ç”¨](#é’©å­ç³»ç»Ÿä½¿ç”¨)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å¿«é€Ÿå¼€å§‹

### åˆ›å»ºä¸€ä¸ªç®€å•çš„æ’ä»¶

æœ€ç®€å•çš„æ’ä»¶åªéœ€è¦å®ç° `ToolPlugin` æ¥å£çš„åŸºæœ¬å­—æ®µï¼š

```typescript
import type { ToolPlugin } from '@/plugins/types'

export const myPlugin: ToolPlugin = {
  id: 'my-plugin',
  name: 'My Plugin',
  type: 'my-type',
  metadata: {
    version: '1.0.0',
    description: 'A simple plugin example',
  },
  createTool: () => {
    return {}
  },
}
```

### æ³¨å†Œæ’ä»¶

æ’ä»¶éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œã€‚å¯¹äºå†…ç½®æ’ä»¶ï¼Œåœ¨ `src/plugins/builtin/index.ts` ä¸­æ·»åŠ ï¼š

```typescript
import { myPlugin } from './my-plugin'

const builtinPlugins: ToolPlugin[] = [
  // ... å…¶ä»–æ’ä»¶
  myPlugin,
]
```

**é‡è¦è¯´æ˜**ï¼š

1. **ä¾èµ–é¡ºåº**ï¼šæ’ä»¶æ³¨å†Œæ—¶ä¼šè‡ªåŠ¨æŒ‰ç…§ä¾èµ–å…³ç³»æ’åºã€‚å¦‚æœæ’ä»¶ A ä¾èµ–æ’ä»¶ Bï¼ˆåœ¨ `metadata.dependencies` ä¸­å£°æ˜ï¼‰ï¼Œæ’ä»¶ B ä¼šå…ˆäºæ’ä»¶ A æ³¨å†Œã€‚

2. **å¾ªç¯ä¾èµ–æ£€æµ‹**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¾ªç¯ä¾èµ–ï¼Œå¦‚æœå‘ç°å¾ªç¯ä¾èµ–ä¼šæŠ›å‡ºé”™è¯¯ã€‚

3. **åˆå§‹åŒ–å‡½æ•°**ï¼šæ‰€æœ‰å†…ç½®æ’ä»¶é€šè¿‡ `initializeBuiltinPlugins()` å‡½æ•°ç»Ÿä¸€æ³¨å†Œï¼Œè¯¥å‡½æ•°ä¼šï¼š
   - è®¡ç®—ä¾èµ–é¡ºåº
   - æŒ‰é¡ºåºæ³¨å†Œæ¯ä¸ªæ’ä»¶
   - æ‰§è¡Œæ¯ä¸ªæ’ä»¶çš„ `onInstall` é’©å­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

4. **åº”ç”¨å¯åŠ¨**ï¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `initializePlugins()` å‡½æ•°æ¥åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿã€‚

### ä½¿ç”¨æ’ä»¶

æ’ä»¶æ³¨å†Œåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

- éªŒè¯æ’ä»¶æ˜¯å¦ç¬¦åˆè§„èŒƒ
- æ£€æŸ¥ä¾èµ–å…³ç³»
- æ£€æµ‹å¿«æ·é”®å†²çª
- æ³¨å†Œé’©å­
- åœ¨å·¥å…·åˆ‡æ¢æ—¶åˆ›å»ºå·¥å…·å®ä¾‹

---

## æ’ä»¶æ¥å£è¯´æ˜

### ToolPlugin æ¥å£

`ToolPlugin` æ˜¯æ’ä»¶çš„æ ¸å¿ƒæ¥å£ï¼Œå®šä¹‰äº†æ’ä»¶å¿…é¡»å®ç°çš„æ‰€æœ‰å­—æ®µï¼š

```typescript
interface ToolPlugin {
  // å¿…éœ€å­—æ®µ
  id: string // æ’ä»¶å”¯ä¸€æ ‡è¯†ç¬¦
  name: string // æ’ä»¶åç§°
  type: string // å·¥å…·ç±»å‹ï¼ˆç”¨äºå·¥å…·åˆ‡æ¢ï¼‰
  metadata: PluginMetadata // æ’ä»¶å…ƒæ•°æ®
  createTool: (context: ToolContext) => ToolInstance // åˆ›å»ºå·¥å…·å®ä¾‹çš„å‡½æ•°

  // å¯é€‰å­—æ®µ
  category?: PluginCategory // æ’ä»¶åˆ†ç±»ï¼š'drawing' | 'selection' | 'utility'
  capabilities?: PluginCapabilities // èƒ½åŠ›å£°æ˜
  ui?: ToolPluginUI // UI é…ç½®
  shortcut?: string // å¿«æ·é”®
  hooks?: PluginHooks // ç”Ÿå‘½å‘¨æœŸé’©å­
  onInstall?: () => void | Promise<void> // å®‰è£…é’©å­
  onUninstall?: () => void | Promise<void> // å¸è½½é’©å­
}
```

### å¿…éœ€å­—æ®µè¯¦è§£

#### id

æ’ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºæ³¨å†Œã€æŸ¥è¯¢å’Œç®¡ç†æ’ä»¶ã€‚å»ºè®®ä½¿ç”¨ kebab-case æ ¼å¼ã€‚

```typescript
id: 'my-plugin' // âœ… æ¨è
id: 'myPlugin' // âš ï¸ ä¸æ¨è
id: 'My Plugin' // âŒ é”™è¯¯
```

#### name

æ’ä»¶çš„æ˜¾ç¤ºåç§°ï¼Œç”¨äºæ—¥å¿—å’Œè°ƒè¯•ã€‚

```typescript
name: 'Rectangle Tool'
```

#### type

å·¥å…·ç±»å‹ï¼Œç”¨äºå·¥å…·åˆ‡æ¢ã€‚å½“ç”¨æˆ·åˆ‡æ¢åˆ°è¯¥å·¥å…·æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨ `type` æ¥æŸ¥æ‰¾å¯¹åº”çš„æ’ä»¶ã€‚

```typescript
type: 'rect' // ä¸ id å¯ä»¥ç›¸åŒï¼Œä¹Ÿå¯ä»¥ä¸åŒ
```

#### metadata

æ’ä»¶å…ƒæ•°æ®ï¼ŒåŒ…å«ç‰ˆæœ¬ã€æè¿°ã€ä½œè€…ã€ä¾èµ–ç­‰ä¿¡æ¯ï¼š

```typescript
metadata: {
  version: '1.0.0',                    // å¿…éœ€ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬å·
  description: 'Rectangle drawing tool', // å¯é€‰ï¼šæ’ä»¶æè¿°
  author: 'Your Name',                  // å¯é€‰ï¼šä½œè€…
  dependencies: ['select'],              // å¯é€‰ï¼šä¾èµ–çš„å…¶ä»–æ’ä»¶ ID
  minCoreVersion: '1.0.0',              // å¯é€‰ï¼šæœ€ä½æ ¸å¿ƒç‰ˆæœ¬è¦æ±‚
}
```

#### createTool

åˆ›å»ºå·¥å…·å®ä¾‹çš„å‡½æ•°ï¼Œæ¥æ”¶ `ToolContext` å¹¶è¿”å› `ToolInstance`ï¼š

```typescript
createTool: (context: ToolContext) => {
  // ä½¿ç”¨ context åˆ›å»ºå¹¶è¿”å›å·¥å…·å®ä¾‹
  return {
    startDrawing: () => {
      /* ... */
    },
    updateDrawing: (e) => {
      /* ... */
    },
    finishDrawing: () => {
      /* ... */
    },
  }
}
```

### å¯é€‰å­—æ®µè¯¦è§£

#### category

æ’ä»¶åˆ†ç±»ï¼Œç”¨äºæ’ä»¶ç®¡ç†å’Œ UI åˆ†ç»„ï¼š

```typescript
category: 'drawing' // ç»˜å›¾å·¥å…·
category: 'selection' // é€‰æ‹©å·¥å…·
category: 'utility' // å®ç”¨å·¥å…·
```

#### capabilities

èƒ½åŠ›å£°æ˜ï¼Œç”¨äºå£°æ˜æ’ä»¶çš„èƒ½åŠ›å’Œè¡Œä¸ºã€‚è¯¦è§ [èƒ½åŠ›å£°æ˜æŒ‡å—](#èƒ½åŠ›å£°æ˜æŒ‡å—)ã€‚

#### ui

UI é…ç½®ï¼Œç”¨äºåœ¨å·¥å…·é€‰æ‹©å™¨ä¸­æ˜¾ç¤ºæ’ä»¶ï¼š

```typescript
ui: {
  label: 'çŸ©å½¢å·¥å…·',                    // æ˜¾ç¤ºæ ‡ç­¾
  iconComponent: 'i-lucide-square',    // å›¾æ ‡ç»„ä»¶ï¼ˆIconify æ ¼å¼ï¼‰
  dividerAfter: true,                   // æ˜¯å¦åœ¨å·¥å…·åæ˜¾ç¤ºåˆ†éš”çº¿
}
```

#### shortcut

å¿«æ·é”®ï¼Œä½¿ç”¨ [KeyboardEvent.code](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/code) æ ¼å¼ï¼š

```typescript
shortcut: 'KeyR' // R é”®
shortcut: 'KeySpace' // ç©ºæ ¼é”®
shortcut: 'KeyV' // V é”®
```

**æ³¨æ„**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¿«æ·é”®å†²çªï¼Œå¹¶åœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Šã€‚

#### hooks

ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œç”¨äºåœ¨å…³é”®èŠ‚ç‚¹æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚è¯¦è§ [é’©å­ç³»ç»Ÿä½¿ç”¨](#é’©å­ç³»ç»Ÿä½¿ç”¨)ã€‚

#### onInstall / onUninstall

æ’ä»¶å®‰è£…å’Œå¸è½½æ—¶çš„é’©å­ï¼Œç”¨äºæ‰§è¡Œåˆå§‹åŒ–æˆ–æ¸…ç†æ“ä½œï¼š

```typescript
onInstall: async () => {
  // æ’ä»¶å®‰è£…æ—¶æ‰§è¡Œ
  console.log('Plugin installed')
}

onUninstall: async () => {
  // æ’ä»¶å¸è½½æ—¶æ‰§è¡Œ
  console.log('Plugin uninstalled')
}
```

---

## èƒ½åŠ›å£°æ˜æŒ‡å—

`PluginCapabilities` æ¥å£ç”¨äºå£°æ˜æ’ä»¶çš„èƒ½åŠ›å’Œè¡Œä¸ºï¼Œç³»ç»Ÿä¼šæ ¹æ®èƒ½åŠ›å£°æ˜è‡ªåŠ¨è°ƒæ•´è¡Œä¸ºã€‚

### èƒ½åŠ›å­—æ®µè¯´æ˜

```typescript
interface PluginCapabilities {
  requiresDrawMode?: boolean // æ˜¯å¦éœ€è¦è¿›å…¥ç»˜å›¾æ¨¡å¼
  requiresNormalMode?: boolean // æ˜¯å¦éœ€è¦è¿›å…¥æ™®é€šæ¨¡å¼
  handlesDragStart?: boolean // æ˜¯å¦å¤„ç†æ‹–æ‹½å¼€å§‹äº‹ä»¶
  handlesDrag?: boolean // æ˜¯å¦å¤„ç†æ‹–æ‹½äº‹ä»¶
  handlesDragEnd?: boolean // æ˜¯å¦å¤„ç†æ‹–æ‹½ç»“æŸäº‹ä»¶
  handlesTap?: boolean // æ˜¯å¦å¤„ç†ç‚¹å‡»äº‹ä»¶
  enablesDrag?: boolean // æ˜¯å¦å¯ç”¨æ‹–æ‹½åŠŸèƒ½ï¼ˆç”¨äºå¹³ç§»å·¥å…·ï¼‰
}
```

### èƒ½åŠ›é©±åŠ¨çš„å·¥ä½œåŸç†

ç³»ç»Ÿä¼šæ ¹æ®èƒ½åŠ›å£°æ˜è‡ªåŠ¨ï¼š

1. **æ¨¡å¼åˆ‡æ¢**ï¼šæ ¹æ® `requiresDrawMode` å’Œ `requiresNormalMode` è‡ªåŠ¨åˆ‡æ¢ç”»å¸ƒæ¨¡å¼
2. **äº‹ä»¶åˆ†å‘**ï¼šæ ¹æ® `handlesDragStart`ã€`handlesDrag`ã€`handlesDragEnd`ã€`handlesTap` å†³å®šæ˜¯å¦å°†äº‹ä»¶ä¼ é€’ç»™å·¥å…·å®ä¾‹
3. **æ‹–æ‹½å¯ç”¨**ï¼šæ ¹æ® `enablesDrag` å†³å®šæ˜¯å¦å¯ç”¨ç”»å¸ƒçš„æ‹–æ‹½åŠŸèƒ½

### å¸¸è§èƒ½åŠ›ç»„åˆ

#### ç»˜å›¾å·¥å…·ï¼ˆå¦‚çŸ©å½¢ã€åœ†å½¢ã€çº¿æ¡ï¼‰

```typescript
capabilities: {
  requiresDrawMode: true,    // éœ€è¦ç»˜å›¾æ¨¡å¼
  handlesDragStart: true,    // å¤„ç†æ‹–æ‹½å¼€å§‹
  handlesDrag: true,         // å¤„ç†æ‹–æ‹½
  handlesDragEnd: true,      // å¤„ç†æ‹–æ‹½ç»“æŸ
}
```

#### é€‰æ‹©å·¥å…·

```typescript
capabilities: {
  requiresNormalMode: true,  // éœ€è¦æ™®é€šæ¨¡å¼
  handlesTap: true,          // å¤„ç†ç‚¹å‡»äº‹ä»¶
}
```

#### å¹³ç§»å·¥å…·

```typescript
capabilities: {
  requiresNormalMode: true,  // éœ€è¦æ™®é€šæ¨¡å¼
  enablesDrag: true,         // å¯ç”¨æ‹–æ‹½åŠŸèƒ½
}
```

#### ç”»ç¬”å·¥å…·ï¼ˆè‡ªç”±ç»˜åˆ¶ï¼‰

```typescript
capabilities: {
  requiresDrawMode: true,
  handlesDragStart: true,
  handlesDrag: true,
  handlesDragEnd: true,
}
```

---

## å·¥å…·å®ä¾‹å®ç°

`ToolInstance` æ¥å£å®šä¹‰äº†å·¥å…·å®ä¾‹éœ€è¦å®ç°çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¼šåœ¨ç›¸åº”çš„æ—¶æœºè¢«ç³»ç»Ÿè°ƒç”¨ã€‚

### ToolInstance æ¥å£

```typescript
interface ToolInstance {
  startDrawing?: () => void // å¼€å§‹ç»˜åˆ¶æ—¶è°ƒç”¨
  updateDrawing?: (e: DragEvent) => void // æ‹–æ‹½æ—¶è°ƒç”¨ï¼ˆç»˜å›¾å·¥å…·ï¼‰
  finishDrawing?: () => void // ç»˜åˆ¶å®Œæˆæ—¶è°ƒç”¨
  handleTap?: (e: PointerEvent) => void // ç‚¹å‡»æ—¶è°ƒç”¨
  onActivate?: () => void // å·¥å…·æ¿€æ´»æ—¶è°ƒç”¨
  onDeactivate?: () => void // å·¥å…·åœç”¨æ—¶è°ƒç”¨
}
```

### ToolContext è¯´æ˜

`createTool` å‡½æ•°æ¥æ”¶çš„ `ToolContext` æä¾›äº†è®¿é—®æ ¸å¿ƒç³»ç»Ÿèµ„æºçš„æ¥å£ï¼š

```typescript
interface ToolContext {
  tree: Tree // Leafer æ ‘å¯¹è±¡ï¼Œç”¨äºæ·»åŠ /åˆ é™¤å…ƒç´ 
  store: ReturnType<typeof useCanvasStore> // Pinia storeï¼Œç”¨äºçŠ¶æ€ç®¡ç†
  isDrawing: Ref<boolean> // æ˜¯å¦æ­£åœ¨ç»˜åˆ¶çš„å“åº”å¼å¼•ç”¨
  startPoint: Ref<Point | null> // ç»˜åˆ¶èµ·å§‹ç‚¹çš„å“åº”å¼å¼•ç”¨
  currentElement: Ref<LeaferElement> // å½“å‰æ­£åœ¨ç»˜åˆ¶çš„å…ƒç´ çš„å“åº”å¼å¼•ç”¨
  isShiftPressed: Ref<boolean> // Shift é”®æ˜¯å¦æŒ‰ä¸‹çš„å“åº”å¼å¼•ç”¨
  penPathPoints?: Ref<Array<Point>> // ç”»ç¬”è·¯å¾„ç‚¹æ•°ç»„ï¼ˆä»…ç”»ç¬”å·¥å…·ï¼‰
  eventBus: PluginEventBus // äº‹ä»¶æ€»çº¿ï¼Œç”¨äºå‘é€å’Œæ¥æ”¶äº‹ä»¶
}
```

### å®ç°æ¨¡å¼

æ’ä»¶å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š

#### 1. ç›´æ¥å®ç°æ¨¡å¼

ç›´æ¥åœ¨ `createTool` å‡½æ•°ä¸­å®ç°æ‰€æœ‰é€»è¾‘ï¼š

```typescript
createTool: (context) => {
  const { tree, store, startPoint, currentElement, isShiftPressed } = context
  
  function startDrawing() {
    // å®ç°é€»è¾‘
  }
  
  function updateDrawing(e: DragEvent) {
    // å®ç°é€»è¾‘
  }
  
  function finishDrawing() {
    // å®ç°é€»è¾‘
  }
  
  return {
    startDrawing,
    updateDrawing,
    finishDrawing,
  }
}
```

#### 2. Composable æ¨¡å¼ï¼ˆæ¨èï¼‰

ä½¿ç”¨ composable å‡½æ•°å°è£…å·¥å…·é€»è¾‘ï¼Œä¾¿äºä»£ç å¤ç”¨å’Œæµ‹è¯•ï¼š

```typescript
import { useRectTool } from '../composables/useRectTool'

createTool: (context) => {
  return useRectTool(
    context.tree,
    context.store,
    context.startPoint,
    context.currentElement,
    context.isShiftPressed
  )
}
```

**æ¨èä½¿ç”¨ composable æ¨¡å¼**ï¼Œå› ä¸ºï¼š
- ä»£ç æ›´ç®€æ´ï¼ŒèŒè´£åˆ†ç¦»æ¸…æ™°
- ä¾¿äºå•å…ƒæµ‹è¯•
- ä¾¿äºåœ¨ä¸åŒæ’ä»¶é—´å¤ç”¨é€»è¾‘
- ç¬¦åˆ Vue 3 Composition API çš„æœ€ä½³å®è·µ

### å®ç°ç¤ºä¾‹

#### ç®€å•çš„ç»˜å›¾å·¥å…·ï¼ˆçŸ©å½¢ï¼‰- ä½¿ç”¨ Composable æ¨¡å¼

```typescript
import { useRectTool } from '../composables/useRectTool'
import type { ToolPlugin } from '@/plugins/types'

export const rectPlugin: ToolPlugin = {
  id: 'rect',
  name: 'Rectangle Tool',
  type: 'rect',
  metadata: {
    version: '1.0.0',
    description: 'Rectangle drawing tool',
  },
  category: 'drawing',
  capabilities: {
    requiresDrawMode: true,
    handlesDragStart: true,
    handlesDrag: true,
    handlesDragEnd: true,
  },
  ui: {
    label: 'çŸ©å½¢å·¥å…·',
    iconComponent: 'i-lucide-square',
  },
  shortcut: 'KeyR',
  createTool: (context) => {
    return useRectTool(
      context.tree,
      context.store,
      context.startPoint,
      context.currentElement,
      context.isShiftPressed
    )
  },
}
```

#### ç®€å•çš„ç»˜å›¾å·¥å…·ï¼ˆçŸ©å½¢ï¼‰- ç›´æ¥å®ç°æ¨¡å¼

å¦‚æœéœ€è¦ç›´æ¥å®ç°ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š

```typescript
import { Rect } from 'leafer-ui'
import type { ToolPlugin, ToolContext } from '@/plugins/types'
import type { DragEvent } from 'leafer-ui'

export const rectPlugin: ToolPlugin = {
  id: 'rect',
  name: 'Rectangle Tool',
  type: 'rect',
  metadata: {
    version: '1.0.0',
    description: 'Rectangle drawing tool',
  },
  category: 'drawing',
  capabilities: {
    requiresDrawMode: true,
    handlesDragStart: true,
    handlesDrag: true,
    handlesDragEnd: true,
  },
  ui: {
    label: 'çŸ©å½¢å·¥å…·',
    iconComponent: 'i-lucide-square',
  },
  shortcut: 'KeyR',
  createTool: (context) => {
    const { tree, store, startPoint, currentElement, isShiftPressed, eventBus } = context

    function startDrawing() {
      if (!tree || !startPoint.value) return

      const rect = new Rect({
        x: startPoint.value.x,
        y: startPoint.value.y,
        width: 0,
        height: 0,
        fill: store.fillColor,
        strokeWidth: 0,
        editable: true,
      })

      currentElement.value = rect
      tree.add(rect)
    }

    function updateDrawing(e: DragEvent) {
      if (!currentElement.value || !startPoint.value) return
      const bounds = e.getPageBounds()

      let width = bounds.width
      let height = bounds.height

      // æŒ‰ä½ Shift é”®ç»˜åˆ¶æ­£æ–¹å½¢
      if (isShiftPressed.value) {
        const size = Math.max(Math.abs(width), Math.abs(height))
        width = width < 0 ? -size : size
        height = height < 0 ? -size : size
      }

      currentElement.value.set({
        x: bounds.x,
        y: bounds.y,
        width,
        height,
      })
    }

    function finishDrawing() {
      if (currentElement.value) {
        const id = store.addObject({
          type: 'rect',
          element: currentElement.value,
        })
        // å¯ä»¥å‘é€äº‹ä»¶é€šçŸ¥å…¶ä»–æ’ä»¶
        eventBus.emit('object:created', {
          id,
          type: 'rect',
          element: currentElement.value,
        })
      }
    }

    return {
      startDrawing,
      updateDrawing,
      finishDrawing,
    }
  },
}
```

#### é€‰æ‹©å·¥å…·ï¼ˆç®€å•å®ç°ï¼‰

```typescript
import type { ToolPlugin, ToolContext } from '@/plugins/types'
import type { PointerEvent } from 'leafer-ui'

export const selectPlugin: ToolPlugin = {
  id: 'select',
  name: 'Select Tool',
  type: 'select',
  metadata: {
    version: '1.0.0',
    description: 'Selection tool for selecting and manipulating objects',
  },
  category: 'selection',
  capabilities: {
    requiresNormalMode: true,
    handlesTap: true,
  },
  ui: {
    label: 'é€‰æ‹©å·¥å…·',
    iconComponent: 'i-lucide-mouse-pointer-2',
  },
  shortcut: 'KeyV',
  createTool: (context) => {
    const { store, eventBus } = context

    function handleTap(e: PointerEvent) {
      // å¤„ç†ç‚¹å‡»é€‰æ‹©é€»è¾‘
      const target = e.target
      if (target && target !== context.tree) {
        // é€‰æ‹©å¯¹è±¡
        store.selectObject(target.id)
        eventBus.emit('object:selected', {
          id: target.id,
          type: target.type,
        })
      }
    }

    return {
      handleTap,
    }
  },
}
```

---

## äº‹ä»¶ç³»ç»Ÿä½¿ç”¨

æ’ä»¶ç³»ç»Ÿæä¾›äº†ç±»å‹å®‰å…¨çš„äº‹ä»¶æ€»çº¿ï¼Œç”¨äºæ’ä»¶ä¹‹é—´ä»¥åŠæ’ä»¶ä¸æ ¸å¿ƒç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ã€‚

### äº‹ä»¶ç±»å‹

ç³»ç»Ÿå®šä¹‰äº†ä»¥ä¸‹äº‹ä»¶ç±»å‹ï¼ˆè¯¦è§ `src/plugins/events.ts`ï¼‰ï¼š

- **æ’ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼š`plugin:activated`ã€`plugin:deactivated`
- **å·¥å…·åˆ‡æ¢**ï¼š`tool:switched`
- **å¯¹è±¡æ“ä½œ**ï¼š`object:created`ã€`object:deleted`ã€`object:selected`ã€`object:modified`
- **ç”»å¸ƒæ“ä½œ**ï¼š`canvas:zoom`ã€`canvas:pan`
- **ç»˜åˆ¶æ“ä½œ**ï¼š`drawing:start`ã€`drawing:update`ã€`drawing:finish`
- **å¿«æ·é”®**ï¼š`shortcut:triggered`

**æ³¨æ„**ï¼š`drawing:finish` äº‹ä»¶åœ¨ç±»å‹å®šä¹‰ä¸­å­˜åœ¨ï¼Œä½†å½“å‰å®ç°ä¸­å¯èƒ½å°šæœªå‘é€ã€‚å»ºè®®é€šè¿‡ `object:created` äº‹ä»¶æ¥ç›‘å¬å¯¹è±¡åˆ›å»ºã€‚

### ä½¿ç”¨äº‹ä»¶æ€»çº¿

#### å‘é€äº‹ä»¶

```typescript
import { pluginEventBus } from '@/plugins'

// åœ¨å·¥å…·å®ä¾‹ä¸­å‘é€äº‹ä»¶
context.eventBus.emit('object:created', {
  id: 'object-123',
  type: 'rect',
  element: rectElement,
})
```

#### ç›‘å¬äº‹ä»¶

```typescript
import { pluginEventBus, pluginEventManager } from '@/plugins'

// åœ¨æ’ä»¶å®‰è£…æ—¶è®¢é˜…äº‹ä»¶
onInstall: async () => {
  const unsubscribe = pluginEventBus.on('object:created', (payload) => {
    console.log('Object created:', payload)
  })

  // ä½¿ç”¨ PluginEventManager è·Ÿè¸ªè®¢é˜…ï¼Œæ’ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†
  pluginEventManager.subscribe('my-plugin', unsubscribe)
}
```

#### ä¸€æ¬¡æ€§ç›‘å¬

```typescript
const unsubscribe = pluginEventBus.once('tool:switched', (payload) => {
  console.log('Tool switched:', payload)
  // ç›‘å¬ä¸€æ¬¡åè‡ªåŠ¨å–æ¶ˆè®¢é˜…
})
```

#### å–æ¶ˆè®¢é˜…

```typescript
// æ‰‹åŠ¨å–æ¶ˆè®¢é˜…
pluginEventBus.off('object:created', handler)

// æˆ–ä½¿ç”¨è¿”å›çš„å–æ¶ˆå‡½æ•°
const unsubscribe = pluginEventBus.on('object:created', handler)
unsubscribe() // å–æ¶ˆè®¢é˜…
```

### äº‹ä»¶è®¢é˜…ç®¡ç†

ä¸ºäº†ç¡®ä¿æ’ä»¶å¸è½½æ—¶æ­£ç¡®æ¸…ç†äº‹ä»¶è®¢é˜…ï¼Œå»ºè®®ä½¿ç”¨ `PluginEventManager`ï¼š

```typescript
import { pluginEventManager } from '@/plugins'

export const myPlugin: ToolPlugin = {
  // ...
  onInstall: async () => {
    // è®¢é˜…äº‹ä»¶
    const unsubscribe1 = pluginEventBus.on('object:created', handler1)
    const unsubscribe2 = pluginEventBus.on('tool:switched', handler2)

    // è·Ÿè¸ªè®¢é˜…
    pluginEventManager.subscribe('my-plugin', unsubscribe1)
    pluginEventManager.subscribe('my-plugin', unsubscribe2)
  },

  onUninstall: async () => {
    // æ’ä»¶å¸è½½æ—¶ï¼ŒPluginEventManager ä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰è®¢é˜…
    // ä½†ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¸…ç†
    pluginEventManager.unsubscribeAll('my-plugin')
  },
}
```

**æ³¨æ„**ï¼šæ’ä»¶å¸è½½æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ `pluginEventManager.unsubscribeAll(pluginId)`ï¼Œæ‰€ä»¥é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†ã€‚

---

## é’©å­ç³»ç»Ÿä½¿ç”¨

é’©å­ç³»ç»Ÿå…è®¸æ’ä»¶åœ¨å…³é”®èŠ‚ç‚¹æ‹¦æˆªæˆ–æ‰©å±•æ ¸å¿ƒç³»ç»Ÿçš„è¡Œä¸ºã€‚

### é’©å­ç±»å‹

ç³»ç»Ÿæä¾›äº†ä»¥ä¸‹é’©å­ï¼š

- **å·¥å…·åˆ‡æ¢é’©å­**ï¼š`beforeToolSwitch`ã€`afterToolSwitch`
- **ç»˜åˆ¶å¼€å§‹é’©å­**ï¼š`beforeDrawingStart`ã€`afterDrawingStart`
- **ç»˜åˆ¶å®Œæˆé’©å­**ï¼š`beforeDrawingFinish`ã€`afterDrawingFinish`

### é’©å­ä¸Šä¸‹æ–‡ç±»å‹

æ¯ä¸ªé’©å­æ¥æ”¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡ç±»å‹å¦‚ä¸‹ï¼š

```typescript
// å·¥å…·åˆ‡æ¢é’©å­ä¸Šä¸‹æ–‡
interface ToolSwitchContext {
  from: string  // æºå·¥å…·ç±»å‹
  to: string    // ç›®æ ‡å·¥å…·ç±»å‹
}

// ç»˜åˆ¶å¼€å§‹é’©å­ä¸Šä¸‹æ–‡
interface DrawingStartContext {
  toolType: string           // å·¥å…·ç±»å‹
  point: { x: number; y: number }  // ç»˜åˆ¶èµ·å§‹ç‚¹
}

// ç»˜åˆ¶å®Œæˆé’©å­ä¸Šä¸‹æ–‡
interface DrawingFinishContext {
  toolType: string    // å·¥å…·ç±»å‹
  objectId?: string   // å¯¹è±¡IDï¼ˆæ³¨æ„ï¼šåœ¨é’©å­è°ƒç”¨æ—¶å¯èƒ½ä¸å¯ç”¨ï¼‰
}
```

**æ³¨æ„**ï¼š`DrawingFinishContext` ä¸­çš„ `objectId` å­—æ®µè™½ç„¶åœ¨ç±»å‹å®šä¹‰ä¸­å­˜åœ¨ï¼Œä½†åœ¨å®é™…é’©å­è°ƒç”¨æ—¶å¯èƒ½ä¸å¯ç”¨ã€‚å¦‚æœéœ€è¦è·å–åˆ›å»ºçš„å¯¹è±¡IDï¼Œå»ºè®®åœ¨å·¥å…·å®ä¾‹çš„ `finishDrawing` æ–¹æ³•ä¸­é€šè¿‡äº‹ä»¶ç³»ç»Ÿå‘é€é€šçŸ¥ã€‚

### é’©å­æ‰§è¡Œé¡ºåº

é’©å­åœ¨ä»¥ä¸‹æ—¶æœºæŒ‰é¡ºåºæ‰§è¡Œï¼š

#### å·¥å…·åˆ‡æ¢æµç¨‹

1. æ—§å·¥å…·çš„ `onDeactivate()` è¢«è°ƒç”¨
2. `beforeToolSwitch` é’©å­æ‰§è¡Œï¼ˆå¦‚æœè¿”å› `false`ï¼Œåˆ‡æ¢è¢«é˜»æ­¢ï¼‰
3. ç”»å¸ƒæ¨¡å¼å’Œæ‹–æ‹½çŠ¶æ€æ›´æ–°
4. æ–°å·¥å…·çš„ `onActivate()` è¢«è°ƒç”¨
5. `afterToolSwitch` é’©å­æ‰§è¡Œ

#### ç»˜åˆ¶æµç¨‹

1. **ç»˜åˆ¶å¼€å§‹**ï¼š
   - `beforeDrawingStart` é’©å­æ‰§è¡Œï¼ˆå¦‚æœè¿”å› `false`ï¼Œç»˜åˆ¶è¢«é˜»æ­¢ï¼‰
   - ç»˜åˆ¶çŠ¶æ€åˆå§‹åŒ–
   - `drawing:start` äº‹ä»¶å‘é€
   - `afterDrawingStart` é’©å­æ‰§è¡Œ
   - å·¥å…·å®ä¾‹çš„ `startDrawing()` è¢«è°ƒç”¨

2. **ç»˜åˆ¶æ›´æ–°**ï¼š
   - `drawing:update` äº‹ä»¶å‘é€
   - å·¥å…·å®ä¾‹çš„ `updateDrawing()` è¢«è°ƒç”¨ï¼ˆæ‹–æ‹½è¿‡ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ï¼‰

3. **ç»˜åˆ¶å®Œæˆ**ï¼š
   - `beforeDrawingFinish` é’©å­æ‰§è¡Œï¼ˆå¦‚æœè¿”å› `false`ï¼Œå®Œæˆè¢«é˜»æ­¢ï¼‰
   - å·¥å…·å®ä¾‹çš„ `finishDrawing()` è¢«è°ƒç”¨
   - `drawing:finish` äº‹ä»¶å‘é€
   - `afterDrawingFinish` é’©å­æ‰§è¡Œ
   - ç»˜åˆ¶çŠ¶æ€é‡ç½®

### é’©å­ç±»å‹è¯´æ˜

#### æ‹¦æˆªå™¨é’©å­ï¼ˆBefore Hooksï¼‰

è¿”å› `boolean`ï¼Œç”¨äºæ‹¦æˆªæ“ä½œï¼š

```typescript
beforeToolSwitch: async (context) => {
  // è¿”å› false å¯ä»¥é˜»æ­¢å·¥å…·åˆ‡æ¢
  if (someCondition) {
    return false // é˜»æ­¢åˆ‡æ¢
  }
  return true // å…è®¸åˆ‡æ¢
}
```

#### å¤„ç†å™¨é’©å­ï¼ˆAfter Hooksï¼‰

ä¸è¿”å›å€¼ï¼Œç”¨äºæ‰§è¡Œåç»­æ“ä½œï¼š

```typescript
afterToolSwitch: async (context) => {
  // å·¥å…·åˆ‡æ¢åæ‰§è¡Œ
  console.log(`Switched from ${context.from} to ${context.to}`)
}
```

### ä½¿ç”¨ç¤ºä¾‹

#### é˜»æ­¢å·¥å…·åˆ‡æ¢

```typescript
export const myPlugin: ToolPlugin = {
  // ...
  hooks: {
    beforeToolSwitch: async (context) => {
      // å¦‚æœæ­£åœ¨ç»˜åˆ¶ï¼Œé˜»æ­¢åˆ‡æ¢åˆ°å…¶ä»–å·¥å…·
      if (isDrawing.value) {
        console.warn('Cannot switch tool while drawing')
        return false
      }
      return true
    },
  },
}
```

#### ç»˜åˆ¶å®Œæˆåçš„å¤„ç†

```typescript
export const myPlugin: ToolPlugin = {
  // ...
  hooks: {
    afterDrawingFinish: async (context) => {
      // ç»˜åˆ¶å®Œæˆåæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
      if (context.toolType === 'rect') {
        console.log('Rectangle drawing finished')
        // æ³¨æ„ï¼šcontext.objectId åœ¨é’©å­è°ƒç”¨æ—¶å¯èƒ½ä¸å¯ç”¨
        // å¦‚æœéœ€è¦è·å–åˆ›å»ºçš„å¯¹è±¡IDï¼Œå»ºè®®åœ¨å·¥å…·å®ä¾‹çš„ finishDrawing æ–¹æ³•ä¸­å‘é€äº‹ä»¶
      }
    },
  },
}
```

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç®€å•çš„ç»˜å›¾å·¥å…·ï¼ˆæ¤­åœ†ï¼‰- ä½¿ç”¨ Composable æ¨¡å¼

```typescript
/**
 * Ellipse tool plugin
 */
import { useCircleTool } from '../composables/useCircleTool'
import type { ToolPlugin } from '@/plugins/types'

export const ellipsePlugin: ToolPlugin = {
  id: 'ellipse',
  name: 'Ellipse Tool',
  type: 'ellipse',
  metadata: {
    version: '1.0.0',
    description: 'Ellipse drawing tool',
    author: 'Your Name',
  },
  category: 'drawing',
  capabilities: {
    requiresDrawMode: true,
    handlesDragStart: true,
    handlesDrag: true,
    handlesDragEnd: true,
  },
  ui: {
    label: 'æ¤­åœ†å·¥å…·',
    iconComponent: 'i-lucide-circle',
  },
  shortcut: 'KeyE',
  createTool: (context) => {
    return useCircleTool(
      context.tree,
      context.store,
      context.startPoint,
      context.currentElement,
      context.isShiftPressed
    )
  },
}
```

### ç¤ºä¾‹ 2ï¼šå¸¦é’©å­å’Œäº‹ä»¶ç›‘å¬çš„æ’ä»¶

```typescript
/**
 * Advanced plugin example with hooks and event listeners
 */
import { pluginEventBus, pluginEventManager } from '@/plugins'
import type { ToolPlugin, ToolContext } from '@/plugins/types'

export const advancedPlugin: ToolPlugin = {
  id: 'advanced-plugin',
  name: 'Advanced Plugin',
  type: 'advanced',
  metadata: {
    version: '1.0.0',
    description: 'Advanced plugin with hooks and events',
  },
  category: 'utility',
  capabilities: {
    requiresNormalMode: true,
  },
  hooks: {
    beforeToolSwitch: async (context) => {
      // è®°å½•å·¥å…·åˆ‡æ¢
      console.log(`Switching from ${context.from} to ${context.to}`)
      return true
    },
    afterDrawingFinish: async (context) => {
      // ç»˜åˆ¶å®Œæˆåæ‰§è¡Œæ“ä½œ
      console.log(`Drawing finished: ${context.toolType}`, context.objectId)
    },
  },
  onInstall: async () => {
    // è®¢é˜…äº‹ä»¶
    const unsubscribe1 = pluginEventBus.on('object:created', (payload) => {
      console.log('Object created:', payload)
    })

    const unsubscribe2 = pluginEventBus.on('tool:switched', (payload) => {
      console.log('Tool switched:', payload)
    })

    // è·Ÿè¸ªè®¢é˜…
    pluginEventManager.subscribe('advanced-plugin', unsubscribe1)
    pluginEventManager.subscribe('advanced-plugin', unsubscribe2)
  },
  createTool: (context) => {
    return {
      onActivate: () => {
        console.log('Advanced plugin activated')
      },
      onDeactivate: () => {
        console.log('Advanced plugin deactivated')
      },
    }
  },
}
```

---

## æœ€ä½³å®è·µ

### 1. æ’ä»¶ ID å’Œç±»å‹å‘½å

- ä½¿ç”¨ kebab-case æ ¼å¼çš„ IDï¼š`my-plugin`ã€`rect-tool`
- ä½¿ç”¨ç®€æ´çš„ç±»å‹åï¼š`rect`ã€`circle`ã€`pen`
- ä¿æŒ ID å’Œç±»å‹çš„ä¸€è‡´æ€§ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤

### 2. èƒ½åŠ›å£°æ˜

- **å§‹ç»ˆå£°æ˜èƒ½åŠ›**ï¼šå³ä½¿æ’ä»¶å¾ˆç®€å•ï¼Œä¹Ÿåº”è¯¥æ˜ç¡®å£°æ˜èƒ½åŠ›
- **é¿å…è¿‡åº¦å£°æ˜**ï¼šåªå£°æ˜æ’ä»¶å®é™…ä½¿ç”¨çš„èƒ½åŠ›
- **ä½¿ç”¨èƒ½åŠ›é©±åŠ¨**ï¼šä¾èµ–èƒ½åŠ›å£°æ˜è€Œéç¡¬ç¼–ç çš„ç±»å‹åˆ¤æ–­

### 3. äº‹ä»¶ä½¿ç”¨

- **ä½¿ç”¨ç±»å‹å®‰å…¨çš„äº‹ä»¶**ï¼šåˆ©ç”¨ TypeScript ç±»å‹æ£€æŸ¥ç¡®ä¿äº‹ä»¶è½½è·æ­£ç¡®
- **åŠæ—¶æ¸…ç†è®¢é˜…**ï¼šä½¿ç”¨ `PluginEventManager` è·Ÿè¸ªè®¢é˜…ï¼Œç¡®ä¿æ’ä»¶å¸è½½æ—¶æ¸…ç†
- **é¿å…äº‹ä»¶å¾ªç¯**ï¼šæ³¨æ„é¿å…äº‹ä»¶ç›‘å¬å™¨è§¦å‘å…¶ä»–äº‹ä»¶å¯¼è‡´æ— é™å¾ªç¯

### 4. é’©å­ä½¿ç”¨

- **è°¨æ…ä½¿ç”¨æ‹¦æˆªå™¨**ï¼š`beforeToolSwitch` ç­‰æ‹¦æˆªå™¨ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œç¡®ä¿æœ‰å……åˆ†çš„ç†ç”±
- **ä¿æŒé’©å­è½»é‡**ï¼šé’©å­åº”è¯¥å¿«é€Ÿæ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
- **å¤„ç†å¼‚æ­¥æ“ä½œ**ï¼šé’©å­å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œä½†è¦ç¡®ä¿æ­£ç¡®å¤„ç† Promise

### 5. å·¥å…·å®ä¾‹å®ç°

- **æ£€æŸ¥ä¸Šä¸‹æ–‡æœ‰æ•ˆæ€§**ï¼šåœ¨ä½¿ç”¨ `startPoint`ã€`currentElement` ç­‰ä¹‹å‰æ£€æŸ¥æ˜¯å¦ä¸º `null`
- **ä½¿ç”¨å“åº”å¼å¼•ç”¨**ï¼šé€šè¿‡ `Ref` è®¿é—®å“åº”å¼æ•°æ®ï¼Œç¡®ä¿å“åº”æ€§
- **å‘é€äº‹ä»¶é€šçŸ¥**ï¼šåœ¨å…³é”®æ“ä½œåå‘é€äº‹ä»¶ï¼Œæ–¹ä¾¿å…¶ä»–æ’ä»¶å“åº”

### 6. é”™è¯¯å¤„ç†

- **éªŒè¯è¾“å…¥**ï¼šåœ¨ `createTool` ä¸­éªŒè¯å¿…éœ€çš„ä¸Šä¸‹æ–‡å­—æ®µ
- **å¤„ç†å¼‚å¸¸**ï¼šä½¿ç”¨ try-catch å¤„ç†å¯èƒ½çš„å¼‚å¸¸
- **æä¾›é”™è¯¯ä¿¡æ¯**ï¼šåœ¨å…ƒæ•°æ®ä¸­æä¾›æ¸…æ™°çš„æè¿°ï¼Œå¸®åŠ©è°ƒè¯•

### 7. æ€§èƒ½ä¼˜åŒ–

- **é¿å…ä¸å¿…è¦çš„è®¡ç®—**ï¼šåœ¨ `updateDrawing` ä¸­é¿å…é‡å¤è®¡ç®—
- **ä½¿ç”¨é˜²æŠ–/èŠ‚æµ**ï¼šå¯¹äºé¢‘ç¹è§¦å‘çš„äº‹ä»¶ï¼Œè€ƒè™‘ä½¿ç”¨é˜²æŠ–æˆ–èŠ‚æµ
- **åŠæ—¶æ¸…ç†èµ„æº**ï¼šåœ¨ `onDeactivate` æˆ– `onUninstall` ä¸­æ¸…ç†èµ„æº

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è·å–å½“å‰é€‰ä¸­çš„å¯¹è±¡ï¼Ÿ

```typescript
createTool: (context) => {
  const { store } = context

  // ä» store è·å–é€‰ä¸­çš„å¯¹è±¡
  const selectedObjectId = store.selectedObjectId
  const selectedObject = store.objects.find(
    (obj) => obj.id === selectedObjectId
  )

  return {}
}
```

### Q2: å¦‚ä½•ä¿®æ”¹ç”»å¸ƒçŠ¶æ€ï¼Ÿ

```typescript
createTool: (context) => {
  const { store } = context

  // ä¿®æ”¹å¡«å……é¢œè‰²
  store.setFillColor('#ff0000')

  // ä¿®æ”¹æè¾¹é¢œè‰²
  store.setStrokeColor('#000000')

  return {}
}
```

### Q3: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å…ƒç´ åˆ°ç”»å¸ƒï¼Ÿ

```typescript
import { Rect } from 'leafer-ui'

createTool: (context) => {
  const { tree, store } = context

  function addCustomElement() {
    const rect = new Rect({
      x: 100,
      y: 100,
      width: 200,
      height: 200,
      fill: '#ff0000',
    })

    tree.add(rect)

    // æ·»åŠ åˆ° store ä»¥ä¾¿ç®¡ç†
    store.addObject({
      type: 'rect',
      element: rect,
    })
  }

  return {
    handleTap: () => {
      addCustomElement()
    },
  }
}
```

### Q4: å¦‚ä½•å®ç°ä¾èµ–å…¶ä»–æ’ä»¶çš„åŠŸèƒ½ï¼Ÿ

```typescript
export const dependentPlugin: ToolPlugin = {
  id: 'dependent-plugin',
  // ...
  metadata: {
    version: '1.0.0',
    dependencies: ['select'], // å£°æ˜ä¾èµ–
  },
  createTool: (context) => {
    // æ£€æŸ¥ä¾èµ–æ’ä»¶æ˜¯å¦å­˜åœ¨
    const selectPlugin = pluginRegistry.get('select')
    if (!selectPlugin) {
      console.error('Select plugin is required')
      return {}
    }

    // ä½¿ç”¨ä¾èµ–æ’ä»¶çš„åŠŸèƒ½
    return {}
  },
}
```

### Q5: å¦‚ä½•å®ç°å¿«æ·é”®ç»„åˆï¼ˆå¦‚ Ctrl+Rï¼‰ï¼Ÿ

å½“å‰ç³»ç»Ÿåªæ”¯æŒå•ä¸ªæŒ‰é”®çš„å¿«æ·é”®ã€‚å¦‚æœéœ€è¦ç»„åˆé”®ï¼Œå¯ä»¥åœ¨å·¥å…·å®ä¾‹ä¸­æ‰‹åŠ¨ç›‘å¬é”®ç›˜äº‹ä»¶ï¼š

```typescript
createTool: (context) => {
  function handleKeyDown(e: KeyboardEvent) {
    if (e.ctrlKey && e.code === 'KeyR') {
      // å¤„ç† Ctrl+R
    }
  }

  // åœ¨æ¿€æ´»æ—¶æ·»åŠ ç›‘å¬å™¨
  return {
    onActivate: () => {
      window.addEventListener('keydown', handleKeyDown)
    },
    onDeactivate: () => {
      window.removeEventListener('keydown', handleKeyDown)
    },
  }
}
```

### Q6: å¦‚ä½•è°ƒè¯•æ’ä»¶ï¼Ÿ

1. **ä½¿ç”¨æ§åˆ¶å°æ—¥å¿—**ï¼šåœ¨å…³é”®ä½ç½®æ·»åŠ  `console.log`
2. **æ£€æŸ¥æ’ä»¶çŠ¶æ€**ï¼šä½¿ç”¨ `pluginRegistry.getState(pluginId)` æŸ¥çœ‹æ’ä»¶çŠ¶æ€
3. **ç›‘å¬äº‹ä»¶**ï¼šä½¿ç”¨ `pluginEventBus.on()` ç›‘å¬ç›¸å…³äº‹ä»¶
4. **æ£€æŸ¥éªŒè¯é”™è¯¯**ï¼šæ’ä»¶æ³¨å†Œæ—¶çš„éªŒè¯é”™è¯¯ä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤º

### Q7: å¦‚ä½•ä½¿ç”¨æ’ä»¶æ³¨å†Œè¡¨ APIï¼Ÿ

æ’ä»¶æ³¨å†Œè¡¨æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š

```typescript
import { pluginRegistry } from '@/plugins'

// æ ¹æ®æ’ä»¶IDè·å–æ’ä»¶
const plugin = pluginRegistry.get('rect')

// æ ¹æ®å·¥å…·ç±»å‹è·å–æ’ä»¶
const plugin = pluginRegistry.getByType('rect')

// è·å–æ‰€æœ‰æ’ä»¶
const allPlugins = pluginRegistry.getAll()

// æ ¹æ®åˆ†ç±»è·å–æ’ä»¶
const drawingPlugins = pluginRegistry.getByCategory('drawing')

// æ£€æŸ¥æ’ä»¶æ˜¯å¦å­˜åœ¨
const exists = pluginRegistry.has('rect')

// è·å–æ’ä»¶çŠ¶æ€
const state = pluginRegistry.getState('rect')
// è¿”å›: { id: string; status: 'registered' | 'activated' | 'deactivated' | 'error'; ... }

// è·å–æ‰€æœ‰æ’ä»¶çš„çŠ¶æ€
const allStates = pluginRegistry.getAllStates()

// æ³¨é”€æ’ä»¶
await pluginRegistry.unregister('rect')

// æ¸…ç©ºæ‰€æœ‰æ’ä»¶ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
pluginRegistry.clear()
```

**æ’ä»¶çŠ¶æ€è¯´æ˜**ï¼š
- `registered`ï¼šæ’ä»¶å·²æ³¨å†Œ
- `activated`ï¼šæ’ä»¶å·²æ¿€æ´»ï¼ˆå½“å‰å·¥å…·ï¼‰
- `deactivated`ï¼šæ’ä»¶å·²åœç”¨
- `error`ï¼šæ’ä»¶æ³¨å†Œæˆ–è¿è¡Œæ—¶å‡ºé”™

### Q8: æ’ä»¶æ³¨å†Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

æ’ä»¶æ³¨å†Œå¤±è´¥é€šå¸¸æ˜¯å› ä¸ºï¼š

1. **ç¼ºå°‘å¿…éœ€å­—æ®µ**ï¼šæ£€æŸ¥ `id`ã€`name`ã€`type`ã€`metadata`ã€`createTool` æ˜¯å¦éƒ½å·²å®šä¹‰
2. **å…ƒæ•°æ®ä¸å®Œæ•´**ï¼šç¡®ä¿ `metadata.version` å·²å®šä¹‰
3. **ä¾èµ–æœªæ³¨å†Œ**ï¼šç¡®ä¿æ‰€æœ‰ä¾èµ–çš„æ’ä»¶éƒ½å·²æ³¨å†Œ
4. **ç‰ˆæœ¬ä¸å…¼å®¹**ï¼šæ£€æŸ¥ `minCoreVersion` æ˜¯å¦æ»¡è¶³è¦æ±‚

æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ï¼Œæ ¹æ®æç¤ºä¿®å¤é—®é¢˜ã€‚

---

## æ€»ç»“

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œæ‚¨åº”è¯¥å·²ç»äº†è§£äº†ï¼š

1. âœ… å¦‚ä½•åˆ›å»ºå’Œæ³¨å†Œæ’ä»¶
2. âœ… æ’ä»¶æ¥å£çš„å„ä¸ªå­—æ®µå«ä¹‰
3. âœ… å¦‚ä½•ä½¿ç”¨èƒ½åŠ›å£°æ˜é©±åŠ¨è¡Œä¸º
4. âœ… å¦‚ä½•å®ç°å·¥å…·å®ä¾‹
5. âœ… å¦‚ä½•ä½¿ç”¨äº‹ä»¶ç³»ç»Ÿè¿›è¡Œé€šä¿¡
6. âœ… å¦‚ä½•ä½¿ç”¨é’©å­ç³»ç»Ÿæ‰©å±•åŠŸèƒ½
7. âœ… æ’ä»¶å¼€å‘çš„æœ€ä½³å®è·µ

å¦‚æœæ‚¨åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š

- [æ’ä»¶åŒ–æ¶æ„å®¡æŸ¥æŠ¥å‘Š](./æ’ä»¶åŒ–æ¶æ„å®¡æŸ¥æŠ¥å‘Š.md) - äº†è§£æ¶æ„è®¾è®¡åŸåˆ™
- `src/plugins/types.ts` - æŸ¥çœ‹å®Œæ•´çš„ç±»å‹å®šä¹‰
- `src/plugins/builtin/` - å‚è€ƒå†…ç½®æ’ä»¶çš„å®ç°
- `src/plugins/events.ts` - æŸ¥çœ‹æ‰€æœ‰å¯ç”¨äº‹ä»¶

ç¥æ‚¨å¼€å‘æ„‰å¿«ï¼ğŸ‰
